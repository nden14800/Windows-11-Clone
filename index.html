<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Windows 11 Clone - Ultimate Edition</title>
    
    <!-- Fonts: Roboto & Segoe UI (System) fallback -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    
    <!-- Icons: Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">

    <style>
        /* --- CSS Variables & Theming --- */
        :root {
            --font-main: 'Segoe UI', 'Roboto', sans-serif;
            --fluent-ease: cubic-bezier(0.1, 0.9, 0.2, 1.0); 
            --fluent-duration: 0.4s;
        }

        /* Light Theme */
        :root {
            --bg-wallpaper: url('https://images.unsplash.com/photo-1579546929518-9e396f3cc809?q=80&w=2070&auto=format&fit=crop');
            --glass-bg: rgba(255, 255, 255, 0.85);
            --glass-border: rgba(255, 255, 255, 0.5);
            --taskbar-bg: rgba(243, 243, 243, 0.85);
            --text-color: #202020;
            --hover-bg: rgba(0, 0, 0, 0.05);
            --active-bg: rgba(0, 0, 0, 0.1);
            --window-shadow: 0 12px 40px rgba(0,0,0,0.18);
            --accent-color: #0067c0;
            --input-bg: #ffffff;
            --spinner-color: #007bff;
            --menu-bg: #ffffff;
            --qs-btn-bg: #ffffff;
            --qs-btn-active: #0067c0;
            --qs-btn-color: #202020;
            --qs-btn-active-color: #ffffff;
            --slider-bg: #d0d0d0;
            --oobe-bg: #f0f0f0;
            --oobe-card: #ffffff;
            --footer-bg: rgba(243, 243, 243, 0.5); /* Footer specific subtle bg */
        }

        /* Dark Theme */
        @media (prefers-color-scheme: dark) {
            :root {
                --bg-wallpaper: url('https://images.unsplash.com/photo-1614850523459-c2f4c699c52e?q=80&w=2070&auto=format&fit=crop');
                --glass-bg: rgba(32, 32, 32, 0.9);
                --glass-border: rgba(255, 255, 255, 0.15);
                --taskbar-bg: rgba(32, 32, 32, 0.85);
                --text-color: #ffffff;
                --hover-bg: rgba(255, 255, 255, 0.08);
                --active-bg: rgba(255, 255, 255, 0.12);
                --window-shadow: 0 12px 40px rgba(0,0,0,0.6);
                --accent-color: #60cdff;
                --input-bg: #2b2b2b;
                --spinner-color: #1a73e8;
                --menu-bg: #2b2b2b;
                --qs-btn-bg: #3c3c3c;
                --qs-btn-active: #60cdff;
                --qs-btn-color: #ffffff;
                --qs-btn-active-color: #202020;
                --slider-bg: #4a4a4a;
                --oobe-bg: #1a1a1a;
                --oobe-card: #2b2b2b;
                --footer-bg: rgba(0, 0, 0, 0.2);
            }
        }

        /* --- Global Styles --- */
        * {
            box-sizing: border-box;
            user-select: none;
            cursor: none !important;
            -webkit-tap-highlight-color: transparent;
        }

        html, body {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100dvh; 
            overflow: hidden;
            position: fixed;
            top: 0;
            left: 0;
            font-family: var(--font-main);
            color: var(--text-color);
            background-image: var(--bg-wallpaper);
            background-size: cover;
            background-position: center;
            transition: background-image 0.5s ease;
            touch-action: none;
            overscroll-behavior: none;
        }

        /* --- Custom Cursor --- */
        #custom-cursor {
            position: fixed;
            top: 0;
            left: 0;
            z-index: 99999999;
            pointer-events: none;
            display: block;
            width: 24px;
            height: 24px;
            color: var(--text-color);
            filter: drop-shadow(0 0 2px rgba(255,255,255,0.8)) drop-shadow(0 1px 3px rgba(0,0,0,0.5));
            will-change: transform;
        }
        @media (prefers-color-scheme: dark) { 
            #custom-cursor { color: white; } 
        }
        @media (prefers-color-scheme: light) { 
            #custom-cursor { color: black; } 
        }

        /* --- Boot Screen (Loader) --- */
        #boot-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: #000000;
            z-index: 99999;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            color: white;
            transition: opacity 0.8s ease;
        }
        
        .boot-logo {
            color: #0078d4;
            margin-bottom: 60px;
        }

        .loader {
            width: 60px;
            height: 60px;
            animation: rotate 1s linear infinite;
            transform-origin: center center;
        }

        .loader .path {
            stroke: white;
            stroke-linecap: round;
            stroke-dasharray: 89 150;
            stroke-dashoffset: 0;
            stroke-width: 2.5;
            fill: none;
        }

        @keyframes rotate { 
            100% { transform: rotate(360deg); } 
        }

        /* --- OOBE (Setup) Screen --- */
        #setup-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: var(--oobe-bg);
            z-index: 99990;
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            opacity: 0;
            transition: opacity 0.5s;
        }
        
        .setup-window {
            width: 90%;
            max-width: 800px;
            height: 80%;
            max-height: 600px;
            background-color: var(--oobe-card);
            border-radius: 8px;
            box-shadow: 0 20px 50px rgba(0,0,0,0.3);
            display: flex;
            overflow: hidden;
        }

        .setup-left {
            width: 40%;
            background-color: var(--oobe-bg);
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
        }
        
        .setup-right {
            width: 60%;
            padding: 40px;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }

        .setup-content h2 { 
            margin-top: 0; 
            font-weight: 400; 
            font-size: 28px; 
            margin-bottom: 20px; 
        }

        .setup-list { 
            list-style: none; 
            padding: 0; 
            max-height: 300px; 
            overflow-y: auto; 
        }

        .setup-item {
            padding: 15px;
            border: 1px solid transparent;
            border-radius: 4px;
            margin-bottom: 5px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .setup-item:hover { background-color: var(--hover-bg); }
        .setup-item.selected { background-color: var(--active-bg); border-color: var(--accent-color); }
        
        .setup-actions { display: flex; justify-content: flex-end; gap: 10px; }
        
        .btn-primary {
            background-color: var(--accent-color);
            color: white;
            border: none;
            padding: 10px 24px;
            border-radius: 4px;
            font-size: 14px;
            cursor: pointer;
        }
        .btn-secondary {
            background-color: transparent;
            color: var(--text-color);
            border: 1px solid var(--glass-border);
            padding: 10px 24px;
            border-radius: 4px;
            font-size: 14px;
            cursor: pointer;
        }

        /* --- Lock & Sign-in Screen --- */
        #lock-screen-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 99980;
            display: none;
            color: white;
        }

        #lock-screen {
            width: 100%;
            height: 100%;
            background-image: var(--bg-wallpaper);
            background-size: cover;
            background-position: center;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding-top: 10vh;
            transition: transform 0.5s var(--fluent-ease), opacity 0.5s;
        }

        .lock-time { 
            font-size: 96px; 
            font-weight: 500; 
            line-height: 1; 
            text-shadow: 0 2px 10px rgba(0,0,0,0.3); 
        }
        .lock-date { 
            font-size: 24px; 
            font-weight: 400; 
            margin-top: 10px; 
            text-shadow: 0 2px 10px rgba(0,0,0,0.3); 
        }

        #signin-screen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.4);
            backdrop-filter: blur(25px);
            -webkit-backdrop-filter: blur(25px);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.5s ease;
        }

        #signin-screen.active { 
            opacity: 1; 
            pointer-events: auto; 
        }

        .signin-avatar {
            width: 120px;
            height: 120px;
            background-color: #0078d4; /* Windows Default Blue */
            border-radius: 50%;
            margin-bottom: 20px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 36px;
            font-weight: bold;
            text-shadow: 0 1px 3px rgba(0,0,0,0.2);
        }
        
        .signin-name { 
            font-size: 24px; 
            font-weight: 500; 
            margin-bottom: 20px; 
            text-shadow: 0 2px 4px rgba(0,0,0,0.5); 
        }
        
        .signin-input-group {
            display: flex;
            gap: 10px;
            background: rgba(255,255,255,0.3);
            padding: 4px;
            border-radius: 4px;
            border: 1px solid rgba(255,255,255,0.2);
        }
        
        .signin-password {
            background: transparent;
            border: none;
            color: white;
            padding: 8px 12px;
            width: 200px;
            outline: none;
        }
        .signin-password::placeholder { color: rgba(255,255,255,0.7); }
        
        .signin-btn {
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            width: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            border-radius: 4px;
        }
        .signin-btn:hover { background: rgba(255,255,255,0.4); }

        /* --- Desktop Container --- */
        #desktop-container {
            width: 100%;
            height: 100%;
            display: none;
            opacity: 0;
            transition: opacity 1s ease;
        }

        /* Desktop Area */
        #desktop {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: calc(100% - 48px);
            padding: 10px;
            display: flex;
            flex-direction: column;
            flex-wrap: wrap;
            align-content: flex-start;
            z-index: 1;
            overflow: hidden;
        }
        
        .desktop-icon {
            width: 86px;
            height: 90px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            padding: 10px 5px;
            border-radius: 4px;
            margin-bottom: 4px;
            text-shadow: 0 1px 3px rgba(0,0,0,0.3);
            border: 1px solid transparent;
            transition: background-color 0.1s, border-color 0.1s;
        }
        .desktop-icon:hover { background-color: rgba(255, 255, 255, 0.1); border-color: rgba(255, 255, 255, 0.05); }
        .desktop-icon.selected { background-color: rgba(255, 255, 255, 0.2); border-color: rgba(255,255,255,0.15); }
        .desktop-icon i { font-size: 32px; margin-bottom: 5px; filter: drop-shadow(0 2px 4px rgba(0,0,0,0.2)); transition: transform 0.1s; }
        .desktop-icon:active i { transform: scale(0.95); }
        .desktop-icon span { font-size: 12px; text-align: center; color: #fff; line-height: 1.2; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }

        /* Windows */
        .window {
            position: absolute;
            width: 600px;
            height: 400px;
            background-color: var(--glass-bg);
            backdrop-filter: blur(25px);
            -webkit-backdrop-filter: blur(25px);
            border: 1px solid var(--glass-border);
            border-radius: 8px;
            box-shadow: var(--window-shadow);
            display: flex;
            flex-direction: column;
            top: 100px; left: 100px;
            overflow: hidden;
            pointer-events: none;
            opacity: 0;
            transform: scale(0.9) translateY(20px);
            transition: transform var(--fluent-duration) var(--fluent-ease), opacity var(--fluent-duration) ease, width 0.3s var(--fluent-ease), height 0.3s var(--fluent-ease), top 0.3s var(--fluent-ease), left 0.3s var(--fluent-ease);
            will-change: transform, opacity, top, left, width, height;
        }
        .window.dragging { transition: none !important; opacity: 0.95; transform: scale(1.02); }
        .window.open { opacity: 1; transform: scale(1) translateY(0); pointer-events: auto; }
        .window.minimized { opacity: 0; transform: scale(0.7) translateY(100px); pointer-events: none; }
        .window.maximized { top: 0 !important; left: 0 !important; width: 100% !important; height: calc(100% - 48px) !important; border-radius: 0; transform: none !important; }
        .window-header { height: 40px; min-height: 40px; display: flex; align-items: center; justify-content: space-between; padding: 0 0 0 12px; border-bottom: 1px solid rgba(128, 128, 128, 0.1); width: 100%; }
        .window-title { font-size: 12px; font-weight: 400; display: flex; align-items: center; gap: 10px; flex: 1; height: 100%; pointer-events: none; }
        .window-title > * { pointer-events: none; }
        .window-controls { display: flex; height: 100%; z-index: 10; }
        .control-btn { width: 46px; height: 100%; display: flex; align-items: center; justify-content: center; font-size: 14px; transition: background 0.15s; border-radius: 4px; margin: 2px; height: calc(100% - 4px); }
        .control-btn:hover { background-color: var(--hover-bg); }
        .control-btn.close:hover { background-color: #e81123; color: white; }
        .window-content { flex: 1; padding: 20px; overflow: auto; font-size: 14px; position: relative; }
        
        /* App Specific Styles */
        .notepad-area { width: 100%; height: 100%; background: transparent; border: none; resize: none; outline: none; font-family: 'Consolas', monospace; font-size: 14px; color: var(--text-color); cursor: none; }
        .calc-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 4px; height: 100%; }
        .calc-display { grid-column: span 4; background: transparent; text-align: right; font-size: 32px; padding: 10px; margin-bottom: 10px; font-weight: 500; }
        .calc-btn { background: var(--hover-bg); border: 1px solid var(--glass-border); border-radius: 4px; display: flex; align-items: center; justify-content: center; font-size: 16px; transition: background 0.2s, transform 0.1s; }
        .calc-btn:hover { background: var(--active-bg); }
        .calc-btn:active { transform: scale(0.95); }
        .calc-btn.accent { background: var(--accent-color); color: white; }
        .drive-item { display: flex; align-items: center; gap: 15px; padding: 10px; border-radius: 4px; margin-bottom: 10px; }
        .drive-item:hover { background-color: var(--hover-bg); }
        .drive-bar-bg { width: 200px; height: 6px; background: rgba(128,128,128,0.3); border-radius: 3px; margin-top: 5px; }
        .drive-bar-fill { height: 100%; background: var(--accent-color); border-radius: 3px; }

        /* Start Menu */
        /* Fixed Layout Logic: Ensure footer stays at bottom and content doesn't push it out */
        #start-menu { 
            position: absolute; 
            bottom: 58px; 
            left: 50%; 
            transform: translateX(-50%) translateY(20px); 
            width: 640px; 
            height: 620px; 
            background-color: var(--glass-bg); 
            backdrop-filter: blur(30px); 
            -webkit-backdrop-filter: blur(30px); 
            border: 1px solid var(--glass-border); 
            border-radius: 8px; 
            box-shadow: var(--window-shadow); 
            z-index: 9999; 
            display: flex; 
            flex-direction: column; 
            padding: 24px 24px 64px 24px; /* Bottom padding reserves space for absolute footer */
            opacity: 0; 
            pointer-events: none; 
            transition: opacity 0.3s ease, transform 0.4s var(--fluent-ease); 
            overflow: hidden; /* Ensures rounded corners and no overflow outside box */
        }
        #start-menu.active { opacity: 1; transform: translateX(-50%) translateY(0); pointer-events: auto; }
        
        .start-search { background-color: var(--input-bg); border: 1px solid transparent; border-bottom: 2px solid var(--accent-color); border-radius: 4px; padding: 8px 12px; display: flex; align-items: center; gap: 10px; margin-bottom: 20px; color: var(--text-color); box-shadow: 0 2px 5px rgba(0,0,0,0.05); flex-shrink: 0; }
        .start-section-title { font-size: 14px; font-weight: 600; margin-bottom: 16px; display: flex; justify-content: space-between; align-items: center; flex-shrink: 0; }
        
        .start-grid { 
            display: grid; 
            grid-template-columns: repeat(6, 1fr); 
            gap: 16px; 
            margin-bottom: 20px; 
            overflow-y: auto; 
            max-height: 280px; /* Limit pinned height */
            min-height: 200px;
            padding-right: 4px; /* Scrollbar space */
        }
        
        /* Recommend list fills remaining space but doesn't push footer out */
        #recommend-list {
            overflow-y: auto;
            flex: 1;
            min-height: 0; /* Allows flex shrinking */
        }

        .start-item { display: flex; flex-direction: column; align-items: center; gap: 8px; padding: 10px 4px; border-radius: 4px; transition: background 0.2s; cursor: pointer; }
        .start-item:hover { background-color: var(--hover-bg); }
        .start-item:active { transform: scale(0.95); }
        .start-item i { font-size: 28px; }
        .start-item span { font-size: 11px; text-align: center; color: var(--text-color); }
        
        /* Footer Fixed at Bottom */
        .start-footer { 
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 54px;
            background-color: var(--footer-bg); 
            border-top: 1px solid rgba(128,128,128,0.1); 
            padding: 0 48px; /* Wider padding for Win11 look */
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            z-index: 2;
        }
        
        .user-profile { display: flex; align-items: center; gap: 12px; padding: 6px 12px; border-radius: 4px; cursor: pointer; transition: background 0.2s; }
        .user-profile:hover { background-color: var(--hover-bg); }

        /* Power Menu */
        #power-menu { position: absolute; bottom: 54px; right: 24px; width: 180px; background-color: var(--menu-bg); border: 1px solid var(--glass-border); border-radius: 6px; box-shadow: 0 4px 12px rgba(0,0,0,0.2); display: none; flex-direction: column; padding: 4px; z-index: 10001; opacity: 0; transform: translateY(10px); transition: opacity 0.2s, transform 0.2s; }
        #power-menu.active { display: flex; opacity: 1; transform: translateY(0); }
        .power-item { padding: 8px 12px; display: flex; align-items: center; gap: 10px; font-size: 13px; border-radius: 4px; color: var(--text-color); cursor: pointer; }
        .power-item:hover { background-color: var(--hover-bg); }

        /* Action Center */
        #action-center { position: absolute; bottom: 58px; right: 10px; width: 360px; background-color: var(--glass-bg); backdrop-filter: blur(30px); -webkit-backdrop-filter: blur(30px); border: 1px solid var(--glass-border); border-radius: 8px; box-shadow: var(--window-shadow); z-index: 9998; padding: 24px; display: flex; flex-direction: column; gap: 20px; opacity: 0; pointer-events: none; transform: translateX(20px); transition: opacity 0.2s, transform 0.2s var(--fluent-ease); }
        #action-center.active { opacity: 1; pointer-events: auto; transform: translateX(0); }
        .quick-settings-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; }
        .qs-btn { background-color: var(--qs-btn-bg); height: 50px; border-radius: 4px; display: flex; align-items: center; justify-content: center; cursor: pointer; border: 1px solid rgba(128,128,128,0.1); transition: all 0.2s; color: var(--qs-btn-color); font-size: 18px; }
        .qs-btn:hover { background-color: var(--hover-bg); }
        .qs-btn:active { transform: scale(0.96); }
        .qs-btn.active { background-color: var(--qs-btn-active); color: var(--qs-btn-active-color); border-color: transparent; }
        .qs-slider-container { display: flex; align-items: center; gap: 15px; }
        .qs-slider-container i { font-size: 20px; width: 24px; text-align: center; }
        .qs-slider { -webkit-appearance: none; width: 100%; height: 4px; background: var(--slider-bg); border-radius: 2px; outline: none; }
        .qs-slider::-webkit-slider-thumb { -webkit-appearance: none; width: 18px; height: 18px; background: var(--accent-color); border-radius: 50%; border: 4px solid var(--menu-bg); cursor: pointer; transition: transform 0.1s; }
        .qs-slider::-webkit-slider-thumb:hover { transform: scale(1.2); }

        /* Calendar */
        #calendar-flyout { position: absolute; bottom: 58px; right: 10px; width: 360px; background-color: var(--glass-bg); backdrop-filter: blur(30px); -webkit-backdrop-filter: blur(30px); border: 1px solid var(--glass-border); border-radius: 8px; box-shadow: var(--window-shadow); z-index: 9998; padding: 20px; display: flex; flex-direction: column; opacity: 0; pointer-events: none; transform: translateY(20px); transition: opacity 0.2s, transform 0.2s var(--fluent-ease); }
        #calendar-flyout.active { opacity: 1; pointer-events: auto; transform: translateY(0); }
        .calendar-header { margin-bottom: 20px; padding-bottom: 15px; border-bottom: 1px solid var(--glass-border); }
        .cal-full-date { font-size: 14px; opacity: 0.8; margin-bottom: 4px; }
        .cal-time-large { font-size: 42px; font-weight: 300; line-height: 1.1; }
        .calendar-body h4 { margin: 0 0 15px 0; font-size: 15px; display: flex; justify-content: space-between; }
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 2px; text-align: center; font-size: 12px; }
        .cal-day-name { font-weight: bold; padding: 8px 0; }
        .cal-day { padding: 8px 0; border-radius: 50%; cursor: pointer; width: 32px; height: 32px; margin: 0 auto; display: flex; align-items: center; justify-content: center; }
        .cal-day:hover { background-color: var(--hover-bg); }
        .cal-day.today { background-color: var(--accent-color); color: white; font-weight: bold; }
        .cal-day.faded { opacity: 0.3; }

        /* Taskbar */
        #taskbar { position: absolute; bottom: 0; left: 0; width: 100%; height: 48px; background-color: var(--taskbar-bg); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); border-top: 1px solid var(--glass-border); display: flex; justify-content: center; align-items: center; z-index: 10000; padding: 0 10px; }
        .taskbar-center { display: flex; align-items: center; gap: 4px; height: 100%; }
        
        /* Taskbar Icon & Indicators */
        .taskbar-icon { width: 40px; height: 40px; border-radius: 4px; display: flex; align-items: center; justify-content: center; font-size: 22px; transition: all 0.2s var(--fluent-ease); position: relative; color: var(--text-color); }
        .taskbar-icon:hover { background-color: var(--hover-bg); }
        .taskbar-icon:active { transform: scale(0.9); } 
        .taskbar-icon.active { background-color: var(--active-bg); }
        
        /* Windows 11 Style Indicator */
        .taskbar-icon.open::after { 
            content: ''; 
            position: absolute; 
            bottom: 2px;
            width: 6px;
            height: 3px; 
            background-color: var(--text-color);
            opacity: 0.5;
            border-radius: 2px; 
            transition: width 0.3s var(--fluent-ease), background-color 0.3s; 
        }
        .taskbar-icon.open.active::after { 
            width: 16px; 
            background-color: var(--accent-color);
            opacity: 1;
        }

        .taskbar-right { position: absolute; right: 10px; height: 100%; display: flex; align-items: center; gap: 8px; }
        .system-tray { display: flex; align-items: center; gap: 12px; padding: 0 12px; height: 40px; border-radius: 4px; font-size: 16px; transition: background 0.2s; }
        .system-tray:hover { background-color: var(--hover-bg); }
        .clock-area { display: flex; flex-direction: column; align-items: flex-end; justify-content: center; padding: 0 12px; height: 40px; border-radius: 4px; font-size: 12px; line-height: 1.2; transition: background 0.2s; }
        .clock-area:hover { background-color: var(--hover-bg); }

        /* Responsive */
        @media (max-width: 768px) {
            #start-menu { width: 95%; bottom: 50px; }
            .window { width: 90%; left: 5% !important; top: 5% !important; height: 70%; }
            .window.maximized { width: 100% !important; left: 0 !important; top: 0 !important; }
            .taskbar-center { gap: 2px; }
            .taskbar-icon { width: 36px; font-size: 20px; }
            #action-center, #calendar-flyout { right: 50%; transform: translateX(50%) translateY(20px); width: 90%; }
            #action-center.active, #calendar-flyout.active { transform: translateX(50%) translateY(0); }
            .setup-window { flex-direction: column; width: 100%; height: 100%; border-radius: 0; }
            .setup-left { width: 100%; height: 30%; }
            .setup-right { width: 100%; height: 70%; padding: 20px; }
        }
    </style>
</head>
<body>

    <!-- Custom Cursor -->
    <div id="custom-cursor">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" class="bi bi-cursor" viewBox="0 0 16 16">
            <path d="M14.082 2.182a.5.5 0 0 1 .103.557L8.528 15.467a.5.5 0 0 1-.917-.007L5.57 10.694.803 8.652a.5.5 0 0 1-.006-.916l12.728-5.657a.5.5 0 0 1 .556.103zM2.25 8.184l3.897 1.67a.5.5 0 0 1 .262.263l1.67 3.897L12.743 3.52z"/>
        </svg>
    </div>

    <!-- Boot Screen -->
    <div id="boot-screen">
        <div class="boot-logo">
            <svg xmlns="http://www.w3.org/2000/svg" width="100" height="100" fill="currentColor" class="bi bi-microsoft" viewBox="0 0 16 16">
                <path d="M7.462 0H0v7.19h7.462zM16 0H8.538v7.19H16zM7.462 8.211H0V16h7.462zm8.538 0H8.538V16H16z"/>
            </svg>
        </div>
        <svg id="spinner" class="loader" viewBox="0 0 50 50">
            <circle class="path" cx="25" cy="25" r="20"></circle>
        </svg>
    </div>

    <!-- OOBE / Setup Screen -->
    <div id="setup-screen">
        <div class="setup-window">
            <div class="setup-left">
                <svg xmlns="http://www.w3.org/2000/svg" width="150" height="150" fill="#0078d4" class="bi bi-microsoft" viewBox="0 0 16 16">
                    <path d="M7.462 0H0v7.19h7.462zM16 0H8.538v7.19H16zM7.462 8.211H0V16h7.462zm8.538 0H8.538V16H16z"/>
                </svg>
            </div>
            <div class="setup-right">
                <div class="setup-content" id="setup-content">
                    <!-- Dynamic Content -->
                </div>
                <div class="setup-actions">
                    <button class="btn-secondary" id="setup-back" style="display:none;">戻る</button>
                    <button class="btn-primary" id="setup-next">はい</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Lock & Sign-in Screen Container -->
    <div id="lock-screen-container">
        <div id="lock-screen" onclick="showSignIn()" onkeydown="showSignIn()">
            <div class="lock-time" id="lock-time">12:00</div>
            <div class="lock-date" id="lock-date">1月1日 日曜日</div>
        </div>

        <div id="signin-screen">
            <div class="signin-avatar">User</div>
            <div class="signin-name">Windows ユーザー</div>
            <div class="signin-input-group">
                <input type="password" class="signin-password" placeholder="パスワード">
                <div class="signin-btn" onclick="unlock()">
                    <i class="bi bi-arrow-right"></i>
                </div>
            </div>
            <div style="margin-top:20px; font-size:12px; opacity:0.7;">サインイン オプション</div>
        </div>
    </div>

    <!-- Desktop Container -->
    <div id="desktop-container">
        <!-- Desktop Icons -->
        <div id="desktop">
            <div class="desktop-icon" onclick="selectIcon(this, event)" ondblclick="openWindow('pc-window')" data-open="pc-window">
                <i class="bi bi-pc-display" style="color: #50e6ff;"></i>
                <span>PC</span>
            </div>
            <div class="desktop-icon" onclick="selectIcon(this, event)" ondblclick="openWindow('recycle-window')" data-open="recycle-window" data-type="recycle">
                <i class="bi bi-trash" style="color: #cccccc;"></i>
                <span>ゴミ箱</span>
            </div>
            <div class="desktop-icon" onclick="selectIcon(this, event)" ondblclick="openWindow('explorer-window')" data-open="explorer-window">
                <i class="bi bi-folder2-open" style="color: #ffe64d;"></i>
                <span>エクスプローラー</span>
            </div>
            <div class="desktop-icon" onclick="selectIcon(this, event)" ondblclick="openWindow('settings-window')" data-open="settings-window">
                <i class="bi bi-gear-fill" style="color: #9caeb8;"></i>
                <span>設定</span>
            </div>
        </div>

        <!-- Windows -->
        <div id="explorer-window" class="window" data-app-id="explorer">
            <div class="window-header">
                <div class="window-title"><i class="bi bi-folder2-open" style="color: #ffe64d;"></i> エクスプローラー</div>
                <div class="window-controls">
                    <div class="control-btn" onclick="minimizeWindow('explorer-window')"><i class="bi bi-dash-lg"></i></div>
                    <div class="control-btn" onclick="toggleMaximize('explorer-window')"><i class="bi bi-square"></i></div>
                    <div class="control-btn close" onclick="closeWindow('explorer-window')"><i class="bi bi-x-lg"></i></div>
                </div>
            </div>
            <div class="window-content">
                <div style="padding-bottom: 10px; border-bottom: 1px solid var(--glass-border); margin-bottom: 15px;">
                    <span style="margin-right: 15px; font-weight: 500;">新規</span>
                    <span style="margin-right: 15px;">切り取り</span>
                    <span style="margin-right: 15px;">コピー</span>
                    <span>貼り付け</span>
                </div>
                <h3>クイックアクセス</h3>
                <div style="display:flex; gap:10px; flex-wrap:wrap; margin-top:10px;">
                    <div style="text-align:center; width:90px; padding:10px; border-radius:4px;" class="start-item"><i class="bi bi-file-earmark-text" style="font-size:36px; color:#50e6ff;"></i><br>ドキュメント</div>
                    <div style="text-align:center; width:90px; padding:10px; border-radius:4px;" class="start-item"><i class="bi bi-card-image" style="font-size:36px; color:#c850ff;"></i><br>ピクチャ</div>
                    <div style="text-align:center; width:90px; padding:10px; border-radius:4px;" class="start-item"><i class="bi bi-music-note-beamed" style="font-size:36px; color:#ff5083;"></i><br>ミュージック</div>
                    <div style="text-align:center; width:90px; padding:10px; border-radius:4px;" class="start-item"><i class="bi bi-download" style="font-size:36px; color:#28a745;"></i><br>ダウンロード</div>
                </div>
            </div>
        </div>

        <div id="settings-window" class="window" data-app-id="settings">
            <div class="window-header">
                <div class="window-title"><i class="bi bi-gear-fill" style="color: #9caeb8;"></i> 設定</div>
                <div class="window-controls">
                    <div class="control-btn" onclick="minimizeWindow('settings-window')"><i class="bi bi-dash-lg"></i></div>
                    <div class="control-btn" onclick="toggleMaximize('settings-window')"><i class="bi bi-square"></i></div>
                    <div class="control-btn close" onclick="closeWindow('settings-window')"><i class="bi bi-x-lg"></i></div>
                </div>
            </div>
            <div class="window-content" style="display: flex;">
                <div style="width: 150px; border-right: 1px solid var(--glass-border); padding-right: 10px;">
                    <div style="padding: 8px; background: var(--active-bg); border-radius: 4px; margin-bottom: 5px;">システム</div>
                    <div style="padding: 8px; border-radius: 4px;">Bluetooth</div>
                    <div style="padding: 8px; border-radius: 4px;">ネットワーク</div>
                </div>
                <div style="flex: 1; padding-left: 20px;">
                    <h2 style="margin-top:0;">システム</h2>
                    <div style="background: var(--hover-bg); padding: 15px; border-radius: 8px; margin-bottom: 10px; display: flex; align-items: center; gap: 15px;">
                        <i class="bi bi-laptop" style="font-size: 24px;"></i>
                        <div><div style="font-weight: bold;">ディスプレイ</div><div style="font-size: 12px; opacity: 0.7;">モニター、明るさ</div></div>
                    </div>
                    <div style="background: var(--hover-bg); padding: 15px; border-radius: 8px; margin-bottom: 10px; display: flex; align-items: center; gap: 15px;">
                        <i class="bi bi-volume-up" style="font-size: 24px;"></i>
                        <div><div style="font-weight: bold;">サウンド</div><div style="font-size: 12px; opacity: 0.7;">ボリューム、出力</div></div>
                    </div>
                </div>
            </div>
        </div>

        <div id="pc-window" class="window" data-app-id="pc">
            <div class="window-header">
                <div class="window-title"><i class="bi bi-pc-display" style="color: #50e6ff;"></i> PC</div>
                <div class="window-controls">
                    <div class="control-btn" onclick="minimizeWindow('pc-window')"><i class="bi bi-dash-lg"></i></div>
                    <div class="control-btn" onclick="toggleMaximize('pc-window')"><i class="bi bi-square"></i></div>
                    <div class="control-btn close" onclick="closeWindow('pc-window')"><i class="bi bi-x-lg"></i></div>
                </div>
            </div>
            <div class="window-content">
                <h4>デバイスとドライブ</h4>
                <div class="drive-item"><i class="bi bi-hdd-fill" style="font-size: 40px; color: #9caeb8;"></i><div><div style="font-size: 14px;">Local Disk (C:)</div><div class="drive-bar-bg"><div class="drive-bar-fill" style="width: 60%;"></div></div><div style="font-size: 11px; opacity: 0.7; margin-top: 4px;">120 GB / 256 GB 空き</div></div></div>
                <div class="drive-item"><i class="bi bi-hdd-fill" style="font-size: 40px; color: #9caeb8;"></i><div><div style="font-size: 14px;">Data (D:)</div><div class="drive-bar-bg"><div class="drive-bar-fill" style="width: 20%;"></div></div><div style="font-size: 11px; opacity: 0.7; margin-top: 4px;">800 GB / 1 TB 空き</div></div></div>
            </div>
        </div>

        <div id="recycle-window" class="window" data-app-id="recycle">
            <div class="window-header">
                <div class="window-title"><i class="bi bi-trash"></i> ゴミ箱</div>
                <div class="window-controls">
                    <div class="control-btn" onclick="minimizeWindow('recycle-window')"><i class="bi bi-dash-lg"></i></div>
                    <div class="control-btn" onclick="toggleMaximize('recycle-window')"><i class="bi bi-square"></i></div>
                    <div class="control-btn close" onclick="closeWindow('recycle-window')"><i class="bi bi-x-lg"></i></div>
                </div>
            </div>
            <div class="window-content">
                <div style="padding: 10px 0; border-bottom: 1px solid var(--glass-border); margin-bottom: 20px;">
                    <button style="padding: 6px 12px; background: transparent; border: 1px solid var(--glass-border); color: var(--text-color); border-radius: 4px;">ゴミ箱を空にする</button>
                </div>
                <div style="display: flex; flex-direction: column; align-items: center; justify-content: center; height: 60%; opacity: 0.6;">
                    <i class="bi bi-folder2-open" style="font-size: 48px; margin-bottom: 10px;"></i><span>このフォルダーは空です。</span>
                </div>
            </div>
        </div>

        <div id="notepad-window" class="window" data-app-id="notepad">
            <div class="window-header">
                <div class="window-title"><i class="bi bi-journal-text" style="color: #0078d7;"></i> 無題 - メモ帳</div>
                <div class="window-controls">
                    <div class="control-btn" onclick="minimizeWindow('notepad-window')"><i class="bi bi-dash-lg"></i></div>
                    <div class="control-btn" onclick="toggleMaximize('notepad-window')"><i class="bi bi-square"></i></div>
                    <div class="control-btn close" onclick="closeWindow('notepad-window')"><i class="bi bi-x-lg"></i></div>
                </div>
            </div>
            <div class="window-content" style="padding: 0;">
                <div style="padding: 4px 10px; border-bottom: 1px solid var(--glass-border); font-size: 12px;"><span style="margin-right: 10px;">ファイル</span><span style="margin-right: 10px;">編集</span><span style="margin-right: 10px;">表示</span></div>
                <div style="padding: 10px; height: calc(100% - 28px);"><textarea class="notepad-area" placeholder="ここに入力..."></textarea></div>
            </div>
        </div>

        <div id="calculator-window" class="window" data-app-id="calculator" style="width: 320px; height: 450px;">
            <div class="window-header">
                <div class="window-title"><i class="bi bi-calculator-fill"></i> 電卓</div>
                <div class="window-controls">
                    <div class="control-btn" onclick="minimizeWindow('calculator-window')"><i class="bi bi-dash-lg"></i></div>
                    <div class="control-btn" onclick="toggleMaximize('calculator-window')"><i class="bi bi-square"></i></div>
                    <div class="control-btn close" onclick="closeWindow('calculator-window')"><i class="bi bi-x-lg"></i></div>
                </div>
            </div>
            <div class="window-content">
                <div style="height: 100%; display: flex; flex-direction: column;">
                    <div class="calc-display" id="calc-display">0</div>
                    <div class="calc-grid">
                        <div class="calc-btn" onclick="clearCalc()">C</div><div class="calc-btn" onclick="appendOp('/')">/</div><div class="calc-btn" onclick="appendOp('*')">×</div><div class="calc-btn" onclick="deleteChar()"><i class="bi bi-backspace"></i></div>
                        <div class="calc-btn" onclick="appendNum('7')">7</div><div class="calc-btn" onclick="appendNum('8')">8</div><div class="calc-btn" onclick="appendNum('9')">9</div><div class="calc-btn" onclick="appendOp('-')">-</div>
                        <div class="calc-btn" onclick="appendNum('4')">4</div><div class="calc-btn" onclick="appendNum('5')">5</div><div class="calc-btn" onclick="appendNum('6')">6</div><div class="calc-btn" onclick="appendOp('+')">+</div>
                        <div class="calc-btn" onclick="appendNum('1')">1</div><div class="calc-btn" onclick="appendNum('2')">2</div><div class="calc-btn" onclick="appendNum('3')">3</div><div class="calc-btn accent" style="grid-row: span 2;" onclick="calcResult()">=</div>
                        <div class="calc-btn" style="grid-column: span 2;" onclick="appendNum('0')">0</div><div class="calc-btn" onclick="appendNum('.')">.</div>
                    </div>
                </div>
            </div>
        </div>

        <div id="universal-app-window" class="window" data-app-id="universal">
            <div class="window-header">
                <div class="window-title" id="uni-app-title"><i class="bi bi-app"></i> アプリ</div>
                <div class="window-controls">
                    <div class="control-btn" onclick="minimizeWindow('universal-app-window')"><i class="bi bi-dash-lg"></i></div>
                    <div class="control-btn" onclick="toggleMaximize('universal-app-window')"><i class="bi bi-square"></i></div>
                    <div class="control-btn close" onclick="closeWindow('universal-app-window')"><i class="bi bi-x-lg"></i></div>
                </div>
            </div>
            <div class="window-content" id="uni-app-content-area"></div>
        </div>

        <div id="action-center">
            <div class="quick-settings-grid">
                <div class="qs-btn active" onclick="toggleQS(this)"><i class="bi bi-wifi"></i></div>
                <div class="qs-btn active" onclick="toggleQS(this)"><i class="bi bi-bluetooth"></i></div>
                <div class="qs-btn" onclick="toggleQS(this)"><i class="bi bi-airplane"></i></div>
                <div class="qs-btn" onclick="toggleQS(this)"><i class="bi bi-battery-half"></i></div>
                <div class="qs-btn" onclick="toggleQS(this)"><i class="bi bi-moon-stars"></i></div>
                <div class="qs-btn" onclick="toggleQS(this)"><i class="bi bi-person-wheelchair"></i></div>
            </div>
            <div class="qs-slider-container"><i class="bi bi-brightness-high"></i><input type="range" class="qs-slider" value="80"></div>
            <div class="qs-slider-container"><i class="bi bi-volume-up"></i><input type="range" class="qs-slider" value="60"></div>
            <div style="display:flex; justify-content:space-between; align-items:center; font-size:12px; margin-top:10px;"><div style="display:flex; align-items:center; gap:8px;"><i class="bi bi-battery-full" style="font-size:16px;"></i> 85%</div><i class="bi bi-gear" style="font-size:16px; cursor:pointer;"></i></div>
        </div>

        <div id="calendar-flyout">
            <div class="calendar-header"><div class="cal-full-date" id="cal-full-date">2023年 11月 19日</div><div class="cal-time-large" id="cal-time-large">12:00:00</div></div>
            <div class="calendar-body"><h4 id="cal-month-year">2023年 11月 <div style="display:flex; gap:10px;"><i class="bi bi-chevron-up"></i><i class="bi bi-chevron-down"></i></div></h4><div class="calendar-grid"><div class="cal-day-name">日</div><div class="cal-day-name">月</div><div class="cal-day-name">火</div><div class="cal-day-name">水</div><div class="cal-day-name">木</div><div class="cal-day-name">金</div><div class="cal-day-name">土</div></div></div>
        </div>

        <!-- Start Menu with Search -->
        <div id="start-menu">
            <div class="start-search">
                <i class="bi bi-search"></i>
                <input type="text" id="start-search-input" placeholder="アプリ、設定、ドキュメントの検索" style="background:transparent; border:none; color:inherit; outline:none; width:100%;">
            </div>
            <div class="start-section-title" id="start-list-title">
                <span>ピン留め済み</span>
                <button style="border:none; background:rgba(255,255,255,0.1); padding:4px 8px; border-radius:4px; color:inherit;">すべてのアプリ <i class="bi bi-chevron-right"></i></button>
            </div>
            <div class="start-grid" id="start-grid">
                <div class="start-item" data-name="メール" onclick="openUniversalApp('メール', 'bi-envelope-at-fill', '#0078d7')"><i class="bi bi-envelope-at-fill" style="color: #0078d7;"></i><span>メール</span></div>
                <div class="start-item" data-name="カレンダー" onclick="openUniversalApp('カレンダー', 'bi-calendar-week', '#0078d7')"><i class="bi bi-calendar-week" style="color: #0078d7;"></i><span>カレンダー</span></div>
                <div class="start-item" data-name="Store" onclick="openUniversalApp('Microsoft Store', 'bi-microsoft', '#0078d7')"><i class="bi bi-microsoft" style="color: #0078d7;"></i><span>Store</span></div>
                <div class="start-item" data-name="フォト" onclick="openUniversalApp('フォト', 'bi-image-fill', '#0078d7')"><i class="bi bi-image-fill" style="color: #0078d7;"></i><span>フォト</span></div>
                <div class="start-item" data-name="設定" onclick="openWindow('settings-window')"><i class="bi bi-gear-fill" style="color: #9caeb8;"></i><span>設定</span></div>
                <div class="start-item" data-name="電卓" onclick="openWindow('calculator-window')"><i class="bi bi-calculator-fill" style="color: #0078d7;"></i><span>電卓</span></div>
                <div class="start-item" data-name="クロック" onclick="openUniversalApp('クロック', 'bi-clock-fill', '#0078d7')"><i class="bi bi-clock-fill" style="color: #0078d7;"></i><span>クロック</span></div>
                <div class="start-item" data-name="メモ帳" onclick="openWindow('notepad-window')"><i class="bi bi-journal-text" style="color: #0078d7;"></i><span>メモ帳</span></div>
                <div class="start-item" data-name="エクスプローラー" onclick="openWindow('explorer-window')"><i class="bi bi-folder2-open" style="color: #ffe64d;"></i><span>エクスプローラー</span></div>
                <div class="start-item" data-name="カメラ" onclick="openUniversalApp('カメラ', 'bi-camera-video-fill', '#0078d7')"><i class="bi bi-camera-video-fill" style="color: #0078d7;"></i><span>カメラ</span></div>
                <div class="start-item" data-name="マップ" onclick="openUniversalApp('マップ', 'bi-map-fill', '#0078d7')"><i class="bi bi-map-fill" style="color: #0078d7;"></i><span>マップ</span></div>
                <div class="start-item" data-name="PC" onclick="openWindow('pc-window')"><i class="bi bi-pc-display" style="color: #50e6ff;"></i><span>PC</span></div>
            </div>
            <div class="start-section-title" id="recommend-title"><span>おすすめ</span></div>
            <div id="recommend-list">
                <div class="start-item" style="flex-direction: row; align-items: center; gap: 15px; padding: 8px 12px;"><i class="bi bi-file-word-fill" style="font-size: 20px; color: #2b579a;"></i><div style="display:flex; flex-direction: column; align-items: flex-start;"><span style="font-size: 12px;">プロジェクト提案書.docx</span><span style="font-size: 10px; opacity: 0.6;">15分前</span></div></div>
                <div class="start-item" style="flex-direction: row; align-items: center; gap: 15px; padding: 8px 12px;"><i class="bi bi-file-pdf-fill" style="font-size: 20px; color: #e13a3a;"></i><div style="display:flex; flex-direction: column; align-items: flex-start;"><span style="font-size: 12px;">請求書_202310.pdf</span><span style="font-size: 10px; opacity: 0.6;">2時間前</span></div></div>
            </div>
            <div class="start-footer">
                <div class="user-profile"><div style="width:32px; height:32px; background: #0078d4; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-size: 11px; font-weight: bold;">User</div><span style="font-size: 12px; font-weight: 500;">Windows ユーザー</span></div>
                <div class="control-btn" id="power-btn" style="width: 40px; border-radius: 4px; font-size: 18px;"><i class="bi bi-power"></i></div>
                <div id="power-menu">
                    <div class="power-item" onclick="powerAction('sleep')"><i class="bi bi-moon"></i> スリープ</div>
                    <div class="power-item" onclick="powerAction('shutdown')"><i class="bi bi-power"></i> シャットダウン</div>
                    <div class="power-item" onclick="powerAction('restart')"><i class="bi bi-arrow-counterclockwise"></i> 再起動</div>
                    <hr style="margin: 2px 0; border:0; border-top:1px solid rgba(128,128,128,0.2);">
                    <div class="power-item" onclick="resetSetup()"><i class="bi bi-arrow-repeat"></i> 初期化して再起動</div>
                </div>
            </div>
        </div>

        <div id="taskbar">
            <div class="taskbar-center">
                <div class="taskbar-icon" id="start-btn" onclick="toggleStartMenu()">
                    <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" fill="currentColor" class="bi bi-microsoft" viewBox="0 0 16 16" style="color: #0078d4;">
                        <path d="M7.462 0H0v7.19h7.462zM16 0H8.538v7.19H16zM7.462 8.211H0V16h7.462zm8.538 0H8.538V16H16z"/>
                    </svg>
                </div>
                <div class="taskbar-icon" onclick="openSearch()"><i class="bi bi-search"></i></div>
                <div class="taskbar-icon"><i class="bi bi-grid-fill"></i></div>
                <div class="taskbar-icon"><i class="bi bi-chat-left-text"></i></div>
                <div class="taskbar-icon" id="tb-explorer" onclick="toggleWindow('explorer-window')"><i class="bi bi-folder2-open" style="color: #ffe64d;"></i></div>
                <div class="taskbar-icon" id="tb-settings" onclick="toggleWindow('settings-window')"><i class="bi bi-gear-fill" style="color: #9caeb8;"></i></div>
            </div>
            <div class="taskbar-right">
                <div class="system-tray" onclick="toggleActionCenter()"><i class="bi bi-chevron-up" style="font-size: 12px;"></i><i class="bi bi-wifi"></i><i class="bi bi-volume-up"></i><i class="bi bi-battery-full"></i></div>
                <div class="clock-area" onclick="toggleCalendar()"><div id="clock-time">12:00</div><div id="clock-date">2023/01/01</div></div>
                <div style="width: 4px; height: 100%; border-left: 1px solid var(--glass-border); margin-left: 4px;"></div>
            </div>
        </div>
    </div>

    <script>
        /* --- Boot Logic --- */
        const bootScreen = document.getElementById('boot-screen');
        const setupScreen = document.getElementById('setup-screen');
        const lockScreenContainer = document.getElementById('lock-screen-container');
        const lockScreen = document.getElementById('lock-screen');
        const signinScreen = document.getElementById('signin-screen');
        const desktopContainer = document.getElementById('desktop-container');
        
        window.onload = () => {
            setTimeout(() => {
                bootScreen.style.opacity = '0';
                setTimeout(() => {
                    bootScreen.style.display = 'none';
                    checkSetup();
                }, 800);
            }, 2000);
        };

        /* --- Setup Logic --- */
        const steps = [
            { title: "国または地域はこれでよろしいですか?", items: ["日本", "アメリカ合衆国", "韓国", "中国", "イギリス"] },
            { title: "これは適切なキーボード レイアウトですか?", items: ["Microsoft IME", "英語 (米国)", "日本語 (Mac)"] },
            { title: "PC に名前を付けましょう", input: true, placeholder: "デバイス名を入力" },
            { title: "ライセンス契約をご確認ください", text: "Windows の使用を開始するには、ライセンス条項に同意する必要があります。" }
        ];
        let currentStep = 0;

        function checkSetup() {
            if (localStorage.getItem('win11_setup_complete')) {
                showLockScreen();
            } else {
                startOOBE();
            }
        }

        function startOOBE() {
            setupScreen.style.display = 'flex';
            setTimeout(() => setupScreen.style.opacity = '1', 50);
            renderStep(0);
        }

        function renderStep(index) {
            const content = document.getElementById('setup-content');
            const nextBtn = document.getElementById('setup-next');
            const backBtn = document.getElementById('setup-back');
            
            content.innerHTML = `<h2>${steps[index].title}</h2>`;
            
            if (steps[index].items) {
                const ul = document.createElement('ul');
                ul.className = 'setup-list';
                steps[index].items.forEach((item, i) => {
                    const li = document.createElement('li');
                    li.className = i === 0 ? 'setup-item selected' : 'setup-item';
                    li.innerText = item;
                    li.onclick = () => {
                        document.querySelectorAll('.setup-item').forEach(el => el.classList.remove('selected'));
                        li.classList.add('selected');
                    };
                    ul.appendChild(li);
                });
                content.appendChild(ul);
            } else if (steps[index].input) {
                const input = document.createElement('input');
                input.type = "text";
                input.placeholder = steps[index].placeholder;
                input.style.width = "100%";
                input.style.padding = "10px";
                input.style.fontSize = "16px";
                content.appendChild(input);
            } else if (steps[index].text) {
                const p = document.createElement('p');
                p.innerText = steps[index].text;
                content.appendChild(p);
            }

            backBtn.style.display = index > 0 ? 'block' : 'none';
            nextBtn.innerText = index === steps.length - 1 ? '同意する' : 'はい';
        }

        document.getElementById('setup-next').addEventListener('click', () => {
            if (currentStep < steps.length - 1) {
                currentStep++;
                renderStep(currentStep);
            } else {
                localStorage.setItem('win11_setup_complete', 'true');
                setupScreen.style.opacity = '0';
                setTimeout(() => {
                    setupScreen.style.display = 'none';
                    showLockScreen();
                }, 500);
            }
        });

        document.getElementById('setup-back').addEventListener('click', () => {
            if (currentStep > 0) {
                currentStep--;
                renderStep(currentStep);
            }
        });

        function resetSetup() {
            if(confirm('PCを初期化して再起動しますか？')) {
                localStorage.removeItem('win11_setup_complete');
                location.reload();
            }
        }

        /* --- Lock & Sign-in Logic --- */
        function showLockScreen() {
            lockScreenContainer.style.display = 'block';
            lockScreen.style.opacity = '1';
            lockScreen.style.transform = 'translateY(0)';
            signinScreen.classList.remove('active');
        }

        function showSignIn() {
            lockScreen.style.transform = 'translateY(-100%)';
            lockScreen.style.opacity = '0';
            signinScreen.classList.add('active');
            document.querySelector('.signin-password').focus();
        }

        function unlock() {
            signinScreen.style.opacity = '0';
            setTimeout(() => {
                lockScreenContainer.style.display = 'none';
                desktopContainer.style.display = 'block';
                setTimeout(() => desktopContainer.style.opacity = '1', 100);
            }, 500);
        }
        document.querySelector('.signin-password').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') unlock();
        });


        /* --- Custom Cursor --- */
        const cursor = document.getElementById('custom-cursor');
        const moveCursor = (e) => {
            let x, y;
            if (e.type.includes('touch')) {
                if(e.touches.length > 0) {
                    x = e.touches[0].clientX;
                    y = e.touches[0].clientY;
                }
            } else {
                x = e.clientX;
                y = e.clientY;
            }
            if(x !== undefined && y !== undefined) {
                cursor.style.transform = `translate(${x}px, ${y}px)`;
            }
        };
        window.addEventListener('mousemove', moveCursor);
        window.addEventListener('touchmove', moveCursor, { passive: false });
        window.addEventListener('touchstart', moveCursor, { passive: false });

        /* --- Clock & Calendar --- */
        function updateClock() {
            const now = new Date();
            const timeStr = `${String(now.getHours()).padStart(2,'0')}:${String(now.getMinutes()).padStart(2,'0')}`;
            const dateStr = `${now.getFullYear()}/${String(now.getMonth()+1).padStart(2,'0')}/${String(now.getDate()).padStart(2,'0')}`;
            
            document.getElementById('clock-time').textContent = timeStr;
            document.getElementById('clock-date').textContent = dateStr;
            document.getElementById('lock-time').textContent = timeStr;
            const days = ['日曜日', '月曜日', '火曜日', '水曜日', '木曜日', '金曜日', '土曜日'];
            document.getElementById('lock-date').textContent = `${now.getMonth()+1}月${now.getDate()}日 ${days[now.getDay()]}`;
            document.getElementById('cal-full-date').textContent = `${now.getFullYear()}年 ${now.getMonth()+1}月 ${now.getDate()}日 ${days[now.getDay()]}`;
            document.getElementById('cal-time-large').textContent = `${timeStr}:${String(now.getSeconds()).padStart(2,'0')}`;
        }
        setInterval(updateClock, 1000);
        updateClock();

        /* --- Menu Management --- */
        const startMenu = document.getElementById('start-menu');
        const powerMenu = document.getElementById('power-menu');
        const actionCenter = document.getElementById('action-center');
        const calendarFlyout = document.getElementById('calendar-flyout');

        function closeAllMenus() {
            startMenu.classList.remove('active');
            powerMenu.classList.remove('active');
            actionCenter.classList.remove('active');
            calendarFlyout.classList.remove('active');
        }
        function toggleStartMenu() { const s = startMenu.classList.contains('active'); closeAllMenus(); if(!s) startMenu.classList.add('active'); }
        function toggleActionCenter() { const s = actionCenter.classList.contains('active'); closeAllMenus(); if(!s) actionCenter.classList.add('active'); }
        function toggleCalendar() { const s = calendarFlyout.classList.contains('active'); closeAllMenus(); if(!s) calendarFlyout.classList.add('active'); }
        function toggleQS(btn) { btn.classList.toggle('active'); }
        
        // Search Logic
        const searchInput = document.getElementById('start-search-input');
        const startGrid = document.getElementById('start-grid');
        const listTitle = document.getElementById('start-list-title');
        const recommendTitle = document.getElementById('recommend-title');
        const recommendList = document.getElementById('recommend-list');

        function openSearch() {
            if(!startMenu.classList.contains('active')) toggleStartMenu();
            searchInput.focus();
        }

        searchInput.addEventListener('input', (e) => {
            const val = e.target.value.toLowerCase();
            const items = startGrid.querySelectorAll('.start-item');
            
            if(val.length > 0) {
                listTitle.querySelector('span').innerText = "検索結果";
                recommendTitle.style.display = 'none';
                recommendList.style.display = 'none';
                items.forEach(item => {
                    const name = item.getAttribute('data-name').toLowerCase();
                    if(name.includes(val)) item.style.display = 'flex';
                    else item.style.display = 'none';
                });
            } else {
                listTitle.querySelector('span').innerText = "ピン留め済み";
                recommendTitle.style.display = 'flex';
                recommendList.style.display = 'flex';
                items.forEach(item => item.style.display = 'flex');
            }
        });

        // Power Button Fix
        document.getElementById('power-btn').addEventListener('click', (e) => {
            e.stopPropagation();
            powerMenu.classList.toggle('active');
        });

        document.addEventListener('click', (e) => {
            if (!e.target.closest('#start-menu') && !e.target.closest('#start-btn') && 
                !e.target.closest('#action-center') && !e.target.closest('.system-tray') &&
                !e.target.closest('#calendar-flyout') && !e.target.closest('.clock-area')) {
                closeAllMenus();
            }
            // Separate check for power menu to allow closing when clicking inside start menu but outside power menu
            if(!e.target.closest('#power-btn') && !e.target.closest('#power-menu')) {
                powerMenu.classList.remove('active');
            }
        });

        /* --- Window & App Logic --- */
        let zIndexCounter = 100;
        
        function openWindow(id) {
            const win = document.getElementById(id);
            if(!win) return;
            win.classList.remove('minimized'); 
            win.classList.add('open');
            zIndexCounter++; 
            win.style.zIndex = zIndexCounter;
            updateTaskbar(id, 'active'); 
            closeAllMenus();
        }
        
        function closeWindow(id) { 
            const win = document.getElementById(id);
            win.classList.remove('open'); 
            win.classList.add('minimized'); 
            setTimeout(() => win.classList.remove('minimized'), 200);
            updateTaskbar(id, 'closed'); 
        }
        
        function minimizeWindow(id) { 
            const win = document.getElementById(id);
            win.classList.add('minimized'); 
            win.classList.remove('open'); 
            updateTaskbar(id, 'minimized');
        }
        
        function toggleMaximize(id) { 
            document.getElementById(id).classList.toggle('maximized'); 
        }
        
        function toggleWindow(id) {
            const win = document.getElementById(id);
            const appId = win.dataset.appId;
            const icon = document.getElementById('tb-'+appId);
            
            if(win.classList.contains('open') && !win.classList.contains('minimized') && win.style.zIndex == zIndexCounter) {
                minimizeWindow(id);
            } 
            else {
                if(win.classList.contains('open')) {
                    zIndexCounter++; win.style.zIndex = zIndexCounter;
                }
                openWindow(id);
            }
        }
        
        function updateTaskbar(id, state) {
             const appId = document.getElementById(id).dataset.appId;
             const icon = document.getElementById('tb-'+appId);
             if(!icon) return;
             
             if(state === 'active') {
                 icon.classList.add('open', 'active');
             } else if (state === 'minimized') {
                 icon.classList.add('open');
                 icon.classList.remove('active');
             } else {
                 icon.classList.remove('open', 'active');
             }
        }
        
        let isDragging = false, currentWin = null, offset = {x:0, y:0};
        document.querySelectorAll('.window-header').forEach(h => {
            const start = (e) => {
                if(e.target.closest('.window-controls')) return;
                currentWin = h.parentElement;
                if(currentWin.classList.contains('maximized')) return;
                isDragging = true; currentWin.classList.add('dragging');
                zIndexCounter++; currentWin.style.zIndex = zIndexCounter;
                updateTaskbar(currentWin.id, 'active');
                const clientX = e.touches ? e.touches[0].clientX : e.clientX;
                const clientY = e.touches ? e.touches[0].clientY : e.clientY;
                const rect = currentWin.getBoundingClientRect();
                offset.x = clientX - rect.left; offset.y = clientY - rect.top;
            };
            h.addEventListener('mousedown', start);
            h.addEventListener('touchstart', start, {passive:false});
        });
        
        const move = (e) => {
            if(!isDragging || !currentWin) return;
            e.preventDefault();
            const clientX = e.touches ? e.touches[0].clientX : e.clientX;
            const clientY = e.touches ? e.touches[0].clientY : e.clientY;
            currentWin.style.left = (clientX - offset.x) + 'px';
            currentWin.style.top = (clientY - offset.y) + 'px';
            currentWin.style.transform = 'scale(1.02)';
        };
        const end = () => {
            if(currentWin) { currentWin.classList.remove('dragging'); currentWin.style.transform = ''; }
            isDragging = false; currentWin = null;
        };
        document.addEventListener('mousemove', move); document.addEventListener('touchmove', move, {passive:false});
        document.addEventListener('mouseup', end); document.addEventListener('touchend', end);

        function selectIcon(el, e) { if(e) e.stopPropagation(); document.querySelectorAll('.desktop-icon').forEach(i=>i.classList.remove('selected')); el.classList.add('selected'); }
        document.getElementById('desktop').addEventListener('click', ()=>document.querySelectorAll('.desktop-icon').forEach(i=>i.classList.remove('selected')));
        document.querySelectorAll('.desktop-icon').forEach(icon => {
            let lastTap = 0;
            icon.addEventListener('touchstart', (e) => {
                const now = new Date().getTime();
                if (now - lastTap < 300) { e.preventDefault(); openWindow(icon.dataset.open); }
                lastTap = now;
            }, {passive:false});
        });

        function openUniversalApp(name, icon, color) {
            const win = document.getElementById('universal-app-window');
            document.getElementById('uni-app-title').innerHTML = `<i class="bi ${icon}" style="color: ${color}"></i> ${name}`;
            document.getElementById('uni-app-content-area').innerHTML = `<div style="display:flex;flex-direction:column;align-items:center;justify-content:center;height:100%;"><i class="bi ${icon}" style="font-size:64px;color:${color};margin-bottom:20px;"></i><h2>${name}</h2></div>`;
            openWindow('universal-app-window');
        }

        // Calculator
        let calcExp = '';
        function appendNum(n){ if(calcExp==='0') calcExp=''; calcExp+=n; updateCalc(); }
        function appendOp(op){ calcExp+=op; updateCalc(); }
        function clearCalc(){ calcExp='0'; updateCalc(); }
        function deleteChar(){ calcExp=calcExp.toString().slice(0,-1); if(calcExp==='') calcExp='0'; updateCalc(); }
        function calcResult(){ try{ calcExp=eval(calcExp).toString(); }catch{ calcExp='Error'; } updateCalc(); }
        function updateCalc(){ document.getElementById('calc-display').innerText = calcExp; }

        // Calendar
        function generateCalendar() {
            const now = new Date();
            const grid = document.querySelector('.calendar-grid');
            const headers = Array.from(grid.children).slice(0,7);
            grid.innerHTML=''; headers.forEach(h=>grid.appendChild(h));
            const firstDay = new Date(now.getFullYear(), now.getMonth(), 1).getDay();
            const daysInMonth = new Date(now.getFullYear(), now.getMonth()+1, 0).getDate();
            for(let i=0; i<firstDay; i++) { const d=document.createElement('div'); d.className='cal-day faded'; grid.appendChild(d); }
            for(let i=1; i<=daysInMonth; i++) {
                const d=document.createElement('div'); d.className='cal-day'; d.innerText=i;
                if(i===now.getDate()) d.classList.add('today');
                grid.appendChild(d);
            }
        }
        generateCalendar();

        function powerAction(act) {
            closeAllMenus();
            if(act === 'shutdown') {
                bootScreen.style.display = 'flex';
                bootScreen.style.opacity = '1';
                setTimeout(() => { document.querySelector('#boot-screen .loader').style.display = 'none'; }, 3000);
            } else if(act === 'restart') {
                bootScreen.style.display = 'flex';
                bootScreen.style.opacity = '1';
                setTimeout(() => location.reload(), 2000);
            } else if(act === 'sleep') {
                showLockScreen();
            }
        }
    </script>
</body>
</html>
